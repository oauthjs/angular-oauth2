!function(e,t){"function"==typeof define&&define.amd?define(["angular","angular-localforage","query-string"],t):"object"==typeof exports?module.exports=t(require("angular"),require("angular-localforage")):e.angularOAuth2=t(e.angular,"LocalForageModule")}(this,function(e,t){function n(e){e.interceptors.push("oauthInterceptor")}function r(e,t,n){return{request:function(e){return e.headers=e.headers||{},n.getAuthorizationHeader().then(function(t){return!e.headers.hasOwnProperty("Authorization")&&t&&(e.headers.Authorization=t),e})},responseError:function(r){return 400!==r.status||!r.data||"invalid_request"!==r.data.error&&"invalid_grant"!==r.data.error||n.removeToken().then(function(){t.$emit("oauth:error",r)}),(401===r.status&&r.data&&"invalid_token"===r.data.error||r.headers("www-authenticate")&&0===r.headers("www-authenticate").indexOf("Bearer"))&&t.$emit("oauth:error",r),e.reject(r)}}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(){var t;this.configure=function(n){if(t)throw new Error("Already configured.");if(!(n instanceof Object))throw new TypeError("Invalid argument: `config` must be an `Object`.");return t=e.extend({},f,n),e.forEach(s,function(e){if(!t[e])throw new Error("Missing parameter: "+e+".")}),"/"===t.baseUrl.substr(-1)&&(t.baseUrl=t.baseUrl.slice(0,-1)),"/"!==t.grantPath[0]&&(t.grantPath="/"+t.grantPath),"/"!==t.revokePath[0]&&(t.revokePath="/"+t.revokePath),t},this.$get=function(n,r){var i=function(){function i(){if(o(this,i),!t)throw new Error("`OAuthProvider` must be configured first.")}return c(i,[{key:"isAuthenticated",value:function(){return r.getToken().then(function(e){return!!e})}},{key:"getAccessToken",value:function(o,i){var u;return o=e.extend({client_id:t.clientId,grant_type:"password"},o),null!==t.clientSecret&&(o.client_secret=t.clientSecret),o=queryString.stringify(o),i=e.extend({headers:{Authorization:void 0,"Content-Type":"application/x-www-form-urlencoded"}},i),n.post(""+t.baseUrl+t.grantPath,o,i).then(function(e){return u=e,r.setToken(u.data)}).then(function(){return u})}},{key:"getRefreshToken",value:function(o,i){var u;return r.getRefreshToken().then(function(r){return o=e.extend({client_id:t.clientId,grant_type:"refresh_token",refresh_token:r},o),null!==t.clientSecret&&(o.client_secret=t.clientSecret),o=queryString.stringify(o),i=e.extend({headers:{Authorization:void 0,"Content-Type":"application/x-www-form-urlencoded"}},i),n.post(""+t.baseUrl+t.grantPath,o,i)}).then(function(e){return u=e,r.setToken(u.data)}).then(function(){return u})}},{key:"revokeToken",value:function(o,i){var u,a,c;return r.getAccessToken().then(function(e){return a=e,r.getRefreshToken()}).then(function(r){return u=r,o=e.extend({client_id:t.clientId,token:u?u:a,token_type_hint:u?"refresh_token":"access_token"},o),null!==t.clientSecret&&(o.client_secret=t.clientSecret),o=queryString.stringify(o),i=e.extend({headers:{"Content-Type":"application/x-www-form-urlencoded"}},i),n.post(""+t.baseUrl+t.revokePath,o,i)}).then(function(e){return c=e,r.removeToken()}).then(function(){return c})}}]),i}();return new i},this.$get.$inject=["$http","OAuthToken"]}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(){var t={name:"token",options:{secure:!0}};this.configure=function(n){if(!(n instanceof Object))throw new TypeError("Invalid argument: `config` must be an `Object`.");return e.extend(t,n),t},this.$get=function(e){var n=function(){function n(){o(this,n)}return c(n,[{key:"setToken",value:function(n){return e.setItem(t.name,n)}},{key:"getToken",value:function(){return e.getItem(t.name).then(function(e){return e})}},{key:"getAccessToken",value:function(){return this.getToken().then(function(e){return e?e.access_token:void 0})}},{key:"getAuthorizationHeader",value:function(){var e,t,n=this;return this.getTokenType().then(function(t){return e=t,n.getAccessToken()}).then(function(n){return t=n,e&&t?e.charAt(0).toUpperCase()+e.substr(1)+" "+t:null})}},{key:"getRefreshToken",value:function(){return this.getToken().then(function(e){return e?e.refresh_token:void 0})}},{key:"getTokenType",value:function(){return this.getToken().then(function(e){return e?e.token_type:void 0})}},{key:"removeToken",value:function(){return e.removeItem(t.name)}}]),n}();return new n},this.$get.$inject=["$localForage"]}var a=e.module("angular-oauth2",[t]).config(n).factory("oauthInterceptor",r).provider("OAuth",i).provider("OAuthToken",u);n.$inject=["$httpProvider"],r.$inject=["$q","$rootScope","OAuthToken"];var c=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f={baseUrl:null,clientId:null,clientSecret:null,grantPath:"/oauth2/token",revokePath:"/oauth2/revoke"},s=["baseUrl","clientId","grantPath","revokePath"],c=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();return a});